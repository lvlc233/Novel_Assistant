# 单元测试文档

## 1. 测试概览

本次测试主要针对 `Novel_Assistant` 后端的小说管理模块 (`novel_api`) 进行集成测试与单元测试。重点覆盖了以下两个核心方面：

1.  **复杂 SQL 聚合查询逻辑**：验证获取小说列表时，基于 `GROUP BY` 和 `LEFT JOIN` 的字数统计功能的正确性。
2.  **异常处理机制**：验证 API 接口在面对业务异常（如用户不存在）和系统异常（如数据库连接失败）时的响应行为。

## 2. 测试详情

### 2.1 小说列表聚合查询测试

**测试目标**：验证 `/novel/get_novels` 接口能否正确返回小说列表，并准确计算每本小说下所有未删除文档版本的总字数。

**测试文件**：`tests/test_novel_api_real_sql.py`

**覆盖场景**：
- 用户拥有多本小说。
- 小说包含多个文档版本，且有不同的字数。
- 小说包含已删除的文档（不应计入字数）。
- 用户拥有已删除的小说（不应出现在列表中）。
- 空小说（无文档）的情况。

**核心代码片段**：

```python
# tests/test_novel_api_real_sql.py

@pytest.mark.anyio
async def test_get_novels_with_word_count(session: AsyncSession, client: AsyncClient):
    """
    Integration test for /get_novels to verify the GROUP BY aggregation logic.
    """
    # ... (数据准备：创建用户、小说、文档、版本) ...

    # Call API
    response = await client.post("/novel/get_novels", json={"user_id": user_id})
    
    # Verify Response
    assert response.status_code == 200
    data = response.json()
    novels = data["data"]
    
    # 验证字数统计准确性
    # Novel 1: Doc1(100) + Doc2(200) = 300 words. (Doc3 is removed)
    n1_res = next(n for n in novels if n["novel_id"] == novel1.novel_id)
    assert n1_res["novel_word_count"] == 300 
```

### 2.2 异常处理测试

**测试目标**：验证 API 层的全局异常处理器能否拦截 Service 层抛出的异常，并返回符合规范的 JSON 错误响应。

**测试文件**：`tests/test_novel_api_exceptions.py`

**覆盖场景**：
- **业务异常**：查询不存在的用户，预期捕获 `UserNotFoundError`，返回错误码 `5102`。
- **系统异常**：模拟数据库连接失败等未知错误，预期捕获通用 `Exception`，返回错误码 `500`。

**关键配置**：
- 使用 `ASGITransport(app=app, raise_app_exceptions=False)` 确保异常被 FastAPI 中间件捕获而不是在测试中崩溃。

**核心代码片段**：

```python
# tests/test_novel_api_exceptions.py

@pytest.mark.anyio
async def test_get_novels_user_not_found(session: AsyncSession, client: AsyncClient):
    """测试用户不存在时的业务异常处理"""
    response = await client.post("/novel/get_novels", json={"user_id": "non_existent"})
    assert response.status_code == 500
    assert response.json()["code"] == "5102"  # UserNotFoundError

@pytest.mark.anyio
async def test_get_novels_generic_exception(session: AsyncSession, client: AsyncClient):
    """测试系统级未知异常处理"""
    with patch("api.routers.novel_api.get_novel_existing_overview_list4service", side_effect=Exception("DB Fail")):
        response = await client.post("/novel/get_novels", json={"user_id": "user_1"})
        assert response.status_code == 500
        assert "DB Fail" in response.json()["message"]
```

## 3. 运行方式

### 环境准备
确保已安装项目依赖（包括 `pytest`, `httpx`, `aiosqlite` 等）。

### 运行所有测试
```powershell
pytest
```

### 运行特定测试文件
```powershell
# 运行聚合查询测试
pytest tests/test_novel_api_real_sql.py

# 运行异常处理测试
pytest tests/test_novel_api_exceptions.py
```

## 4. 结果分析

| 测试用例 | 状态 | 说明 |
| :--- | :--- | :--- |
| `test_get_novels_with_word_count` | **Passed** | SQL `GROUP BY` 和 `SUM` 聚合逻辑正确，已删除文档未被误统计。 |
| `test_get_novels_user_not_found` | **Passed** | 业务异常 `UserNotFoundError` 正确映射为 5102 错误码。 |
| `test_get_novels_generic_exception` | **Passed** | 全局异常处理器能够兜底未知异常，服务未崩溃。 |

**遗留/待改进点**：
- 字数统计目前依赖数据库字段 `document_word_count`。需确保在写入文档版本时（`create_novel_document_version`）正确调用了 Python 层的 `count_words` 函数进行计算，否则数据库中的字数可能为 0。

---
*文档生成时间：2025-12-22*
